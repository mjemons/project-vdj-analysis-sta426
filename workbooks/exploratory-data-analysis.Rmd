# Exploratory Data Analysis

In the following section we perform an exploratory data analysis to better 
understand the makeup of the meta-data related to the patients.

## Sample-level Descriptive Statistics

The patient meta-data was provided as a `SingleCellExperiment` format.
```{r, message=FALSE, warning=FALSE}
library(dotenv)
load_dot_env(file = ".env")

library(dplyr)
library(SummarizedExperiment)
library(stringr)

# Load data, note that sce_B.rds should be in data/
experiment = readRDS(paste0(Sys.getenv(c("HOME_DIR")), "data/sce_B.rds"),
                     refhook = NULL)
cellUMI2SampleType_raw = colData(experiment) %>% as.data.frame


cellUMI2SampleType = cellUMI2SampleType_raw %>% select(lib_id, patient_id,
                                                       Sample.Type,
                                                       Diagnosis) %>% unique()

#counting the number of AP and nonAP patients
count_nonap <- sum(str_count(cellUMI2SampleType$Sample.Type, "CFSEhi CD19+"))
count_ap <- sum(str_count(cellUMI2SampleType$Sample.Type, "CFSEdim CD19+"))
```

There are `r count_ap` AP patients and `r count_nonap` nonAP patients
in the dataset.

Next the population statistics is visualised. First we set CFSEdim to
be AP and CFSEhi to be nonAP (see introduction for a rationale).

```{r, message=FALSE, warning=FALSE}
library(ggplot2)

# change CFSEdim CD19+ to AP and CFSEhi CD19+ to nonAP
simplified_annotation = cellUMI2SampleType %>%
  mutate(Sample.Type = ifelse(Sample.Type == "CFSEdim CD19+", "AP", "nonAP"))

#visualisation of the patient composition
p <- ggplot(simplified_annotation, aes(x = Sample.Type, fill = Diagnosis)) +
    geom_bar(position="dodge")  +
    ggtitle("Sample Dataset (n = 31)")

p

save(simplified_annotation, file = "annotation.RData")
```

We see that the proportion of samples is  homogeneous with respect to Diagnosis
and treatment combinations in AP and nonAP sample types.

## Cell-level Descriptive Statistics

Next we want to inspect how many cells we have per AP and nonAP sample.

```{r, message = FALSE, warning=FALSE}
library(reshape)

labels <- simplified_annotation$lib_id
countlabel <- t(c(rep(0,31))) %>% as.data.frame()
colnames(countlabel) <- labels
rownames(countlabel) <- "count"

#counting the number of cells per patient ID
for(label in labels){
 countlabel[label] <- sum(str_count(cellUMI2SampleType_raw$lib_id, label))
}

countlabel <- melt(countlabel)

countlabel$label <- simplified_annotation$Sample.Type

#counting the number of cells per condition
cells_ap = 0
cells_nonap = 0
for(i in 1:31){
  if(countlabel[i,"label"] == "AP"){
    cells_ap = cells_ap + countlabel[i,"value"]
  }
  else{
    cells_nonap = cells_nonap + countlabel[i,"value"]
  }
}

#visualisation of the cell counts per patient
p <- ggplot(countlabel, aes(x = variable, y= value, colour = label)) +
  geom_point(stat='identity') + theme(axis.text.x = element_text(angle = 90)) +
  xlab("lib_ID") + ylab ("Count") + ggtitle("Cell count per Sample")

p
```

We see that we have cell counts in the range of $\approx$ 1000 up
to $\approx$ 5000 per sample. Over the two conditions AP and nonAP the
distribution is quite similar with `r format(cells_ap, scientific=FALSE)` AP
cells and `r format(cells_nonap, scientific=FALSE)` nonAP cells.

A check for normality is done via a Q-Q plot and a Shapiro-Wilk normality test.
```{r, message = FALSE}
#histogram of count_data
hist(countlabel$value, xlab = "Cell Count per Sample", 
     main = "Histogram of Cell Count")

#adding Q-Q plot to check for normality of data
p <- ggplot(countlabel, aes(sample = value)) +
  stat_qq(col = "blue") + stat_qq_line(col = "red" ) +
  ggtitle("Normal Q-Q plot")
p

#doing shapiro wilk test for normality
shapiro.test(countlabel$value)
```

From our Q-Q plot we see that the data is only normally distributed in a narrow
range even though the Shapiro-Wilk test indicates a very weak support for a
normal distribution.

In a last step the proportion of A P cells vs nonAP cells over all samples
is analysed.
```{r, message = FALSE}
#showing the proportion of the cumulative sum of AP vs nonAP cells
summary.df <- data.frame()
summary.df <- cbind(c(cells_ap, cells_nonap))
rownames(summary.df) <- c("AP", "nonAP")
summary.df <- melt(summary.df)

colnames(summary.df) <- c("Type", "X2", "value")

p <- ggplot(summary.df, aes(x = "", y = value, fill = Type)) +
  geom_bar(stat = "identity") + xlab ("Cumsum of Cells") +
  ggtitle("Proportion of overall AP vs nonAP cells")
p
```

Overall we see that the dataset is well-balanced and we have similar amounts of 
patients per diagnosis (Healty Donor, RRMS nihil and RRMS NAT) and we have similar
amounts of cells per condition (AP vs nonAP). Furthermore, it is not the case that
one patient accounts for the majority of cells per condition but that these cells
are quite nicely mixed from different samples (see Cell Count per Sample plot). 
The Q-Q plot and the Shapiro-Wilk don't give a clear-cut decision whether
the data is normal or not, motivating never the less the more cautious 
nonparametric assumption for downstream analysis.

```{r message=FALSE, warning=FALSE, include=FALSE, include=FALSE}
# clean up to free up memory
rm(list = ls())
```
