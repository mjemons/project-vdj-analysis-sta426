# Frequency of clonal expansion

```{r load summarized data and calculate annotation frequencies, message=FALSE, warning=FALSE}
library(dotenv)
library(dplyr)
library(SummarizedExperiment)
library(reshape2)

load("annotation.RData")
load_dot_env(file = ".env")


# Load data, note that summarise_data should be in data/
file_path = paste0(Sys.getenv(c("HOME_DIR")),"data/summarise_data")

# determine the highest clonotype size in the data
max_clonotype_size = 0
for (i in list.files(path = file_path)){

  tmp_path = paste0(file_path,"/",i,"/clonotype_sizes.txt")
  tmp = read.table(tmp_path, header = TRUE)


  if (max(tmp$clonotype_size) > max_clonotype_size){
    max_clonotype_size = max(tmp$clonotype_size)
  }
}

# prepare empty data frame (df for frequency and df_complete for clonotype counts)
df = data.frame(lib_id = character(), expansion_frequency = double())
df_complete = data.frame()
lib_ids = c()

# loop over all files and fill the dataframes
for (i in list.files(path = file_path)){

  tmp_path = paste0(file_path,"/",i,"/clonotype_sizes.txt")
  tmp = read.table(tmp_path, header = TRUE)

  # calculate frequency of clonal expansion (clonotype size >= 2)
  freq=tmp$clonotype_size*tmp$clonotype_count
  sum_freq=sum(freq)
  freq=(sum_freq - freq[1])/sum_freq

  #split the string at "-" or "_" to remove "-preprocessed" and "POOL*" and
  # remove the "B"
  lib_name = strsplit(i, "[-_]+") %>% unlist() %>% .[1]
  lib_name = sub("B","",lib_name)

  expand_tmp = list(lib_id = lib_name, expansion_frequency = freq)
  df = rbind(df,expand_tmp)

  lib_ids = c(lib_ids,lib_name)

  # fill vector with zeros up to max clonotype size to have equal lengths
  adjusted_clonotype_count = c(tmp$clonotype_count,
                              rep(0,(max_clonotype_size -
                              max(tmp$clonotype_size))))

  df_complete = rbind(df_complete, adjusted_clonotype_count)
  }

colnames(df_complete) = 1:max_clonotype_size
rownames(df_complete) = lib_ids
```

```{r, message=FALSE, warning=FALSE}
#plotting the clustering of id's according to their clonotype
library(dendextend)

#get rid of sample 43 that we couldn't summarise
simplified_annotation_cut <- simplified_annotation[-19,]


dist_mat = dist(df_complete, method = 'euclidean')
hclust_avg = hclust(dist_mat, method = 'average')
avg_dend_obj = as.dendrogram(hclust_avg)

colors_to_use <- as.numeric(as.factor(simplified_annotation_cut$Sample.Type))
colors_to_use <- colors_to_use[order.dendrogram(avg_dend_obj)]

labels_colors(avg_dend_obj) <- colors_to_use

plot(avg_dend_obj, main = "Dendrogram of Samples coloured by AP vs nonAP")
```


```{r condensing dataframe}
# condense all clonotypes > 4 into one category and make a new data frame
condensed_sum = rowSums(df_complete[-c(1:4)])
df_summarized = cbind(df_complete[c(1:4)],condensed_sum)
colnames(df_summarized) = c(1:4, "> 4")
```

```{r add the sample type to the dataframe, message=FALSE, warning=FALSE}
library(tidyr)
library(gtable)

# cut the lib id string and keep only the first part
separate(data = simplified_annotation, col = lib_id, into = c("lib_id", "rest"), extra = "merge") %>% select(-rest) -> simplified_annotation

# merge the annotation with the data frames
df = merge(df, simplified_annotation, by.x = "lib_id", by.y = "lib_id")
rownames(simplified_annotation) = simplified_annotation$lib_id

df_summarized = merge(df_summarized, simplified_annotation, by = "row.names")

rownames(df_summarized) = df_summarized$Row.names
df_summarized = subset(df_summarized, select = -Row.names)

```


```{r, plot the clonal expansion}
library(ggplot2)
melted = melt(df_summarized, id.vars = c("lib_id", "Sample.Type", "Diagnosis", "HLADR15"))
ggplot(data = melted, aes(fill=variable, x=lib_id, y=value)) +
  geom_bar(stat="identity", position = position_stack(reverse = TRUE)) +
  theme(axis.text.x = element_text(angle = 90)) +
  facet_grid(.~Sample.Type, scales = "free_x") +
  labs(fill = "Clonal expansion") +
  xlab("Sample Id") + ylab("Clonotype Count")
```

```{r plot the frequencies, message=FALSE, warning=FALSE}
library(ggplot2)
p <- ggplot(df, aes(x = Sample.Type, y = expansion_frequency, color = Diagnosis)) + geom_point() +
  xlab("Sample Type") + ylab("clonal expansion frequency") + ylim(0,1) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p
```

```{r}
#Shapiro-Wilk test to assess whether expansion frequencies are normal or not
shapiro.test(df$expansion_frequency)
```

The Shapiro-Wilk test justifies the usage of a nonparameteric test as the
Wilcoxon test used here.

```{r Mann-Whitney-Wilcoxon Test}
wilcox.test(expansion_frequency ~ Sample.Type, data=df)
```

```{r plot frequency for HLADR15}
library(ggplot2)
p <- ggplot(df %>% subset(HLADR15 != "?"), aes(x = Sample.Type, y = expansion_frequency, color = Diagnosis)) + geom_point() +
  xlab("Sample Type") + ylab("clonal expansion frequency") + ylim(0,1) +
  theme_bw() +
  facet_grid(.~HLADR15, scales = "free_x") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p
```

```{r clean up, include=FALSE}
# clean up to free up memory
rm(list = ls())
```
