# Frequency of clonal expansion

```{r load summarized data and calculate annotation frequencies, message=FALSE, warning=FALSE}
# Loads environment variables for host-agnostic execution
# Variables in .env can be accessed using Sys.getenv(c("VAR"))
# See https://stat.ethz.ch/R-manual/R-devel/library/base/html/Sys.getenv.html
# Make sure that the knit directory is set to the home directory of the project
# prior to knitting

library(magrittr)
library(dotenv)
library(dplyr)
library(SummarizedExperiment)

load_dot_env(file = ".env")


# Load data, note that summarise_data should be in data/
file_path = paste0(Sys.getenv(c("HOME_DIR")),"data/summarise_data")


# prepare empty data frame
df = data.frame(lib_id = character(), expansion_frequency = double())


for (i in list.files(path = file_path)){
  
  tmp_path = paste0(file_path,"/",i,"/clonotype_sizes.txt")
  tmp = read.table(tmp_path, header = TRUE)
  
  freq=tmp$clonotype_size*tmp$clonotype_count
  sum_freq=sum(freq)
  freq=(sum_freq - freq[1])/sum_freq
  
  #split the string at "-" or "_" to remove "-preprocessed" and "POOL*" and 
  # remove the "B
  patient_name = strsplit(i, "[-_]+") %>% unlist() %>% .[1]
  patient_name = sub("B","",patient_name)
  
  expand_tmp = list(lib_id = patient_name, expansion_frequency = freq)
  df = rbind(df,expand_tmp)
  }


```

```{r load the annotation data, message=FALSE, warning=FALSE}
library(SingleCellExperiment)
experiment = readRDS(paste0(Sys.getenv(c("HOME_DIR")), "data/sce_B.rds"),
                     refhook = NULL)
```

```{r add the sample type to the dataframe, message=FALSE, warning=FALSE}
library(tidyr)
experiment@colData %>% as.data.frame() %>% select(lib_id, Sample.Type, Diagnosis) %>% 
  unique() -> annotation_df

separate(data = annotation_df, col = lib_id, into = c("lib_id", "rest"), extra = "merge") %>% select(-rest) -> simplified_annotation

df = merge(df, simplified_annotation, by.x = "lib_id", by.y = "lib_id")
```



```{r plot the frequencies, message=FALSE, warning=FALSE}
library(ggplot2)
p <- ggplot(df, aes(x = Sample.Type, y = expansion_frequency, color = Diagnosis)) + geom_point() +
  xlab("Sample Type") + ylab("clonal expansion frequency") + ylim(0,1) + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p
```

```{r Mann-Whitney-Wilcoxon Test}
wilcox.test(expansion_frequency ~ Sample.Type, data=df) 
```

```{r}
# clean up to free up memory
rm(list = ls())
```